<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="me.realimpact.telecom.calculation.infrastructure.adapter.mybatis.ContractQueryMapper">

    <!-- 계약 ID 목록 조회 (Spring Batch용) -->
    <select id="findContractIds" resultType="Long">
        SELECT DISTINCT c.contract_id
        FROM contract c
        WHERE 1=1
        <!-- 계약 ID 조건 (조건부) -->
        <if test="contractIds != null and contractIds.size() > 0">
            AND c.contract_id IN
            <foreach item="contractId" collection="contractIds" open="(" separator="," close=")">
                #{contractId}
            </foreach>
        </if>

        <!-- 계약 유효 기간 필터링 -->
        AND COALESCE(c.subscribed_at, DATE '1900-01-01') &lt;= #{billingEndDate}
        AND COALESCE(c.terminated_at, DATE '9999-12-31') &gt; #{billingStartDate}
        AND COALESCE(c.initially_subscribed_at, DATE '1900-01-01') &lt;= #{billingEndDate}
        AND COALESCE(c.preffered_termination_date, DATE '9999-12-31') &gt; #{billingStartDate}
        ORDER BY c.contract_id
    </select>

    <!-- 파티션 기반 계약 ID 목록 조회 (Partitioner용) -->
    <select id="findContractIdsWithPartition" resultType="Long">
        SELECT DISTINCT c.contract_id
        FROM contract c
        WHERE 1=1
    <!-- 파티션 조건: contractId MOD partitionCount = partitionKey (Oracle) -->
    AND MOD(c.contract_id, #{partitionCount}) = #{partitionKey}

        <!-- 계약 유효 기간 필터링 -->
        AND COALESCE(c.subscribed_at, DATE '1900-01-01') &lt;= #{billingEndDate}
        AND COALESCE(c.terminated_at, DATE '9999-12-31') &gt; #{billingStartDate}
        AND COALESCE(c.initially_subscribed_at, DATE '1900-01-01') &lt;= #{billingEndDate}
        AND COALESCE(c.preffered_termination_date, DATE '9999-12-31') &gt; #{billingStartDate}
        ORDER BY c.contract_id
    </select>

    <!-- 특정 계약 ID 목록 조회 (파티션 필터링된 계약용) -->
    <select id="findSpecificContractIds" resultType="Long">
        SELECT DISTINCT c.contract_id
        FROM contract c
        WHERE c.contract_id IN
        <foreach item="contractId" collection="contractIds" open="(" separator="," close=")">
            #{contractId}
        </foreach>
        ORDER BY c.contract_id
    </select>

    <!-- 빈 결과 조회 (파티션에 해당하는 계약이 없을 때) -->
    <select id="findEmptyContractIds" resultType="Long">
        SELECT c.contract_id
        FROM contract c
        WHERE 1=0  -- 항상 빈 결과 반환
    </select>


</mapper>